---
title: "Final"
author: "Emily Mauch"
date: "4/18/2022"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Packages to install, eval=FALSE}
install.packages("naniar")
install.packages("igraph")
install.packages("ggraph")
install.packages("visNetwork")
install.packages('DT')

```

```{r Packages to open, include=FALSE}
library(tidyverse)
library(rvest) 
library(naniar)
library(igraph)
library(ggraph)
library(visNetwork)            
library(DT)
library(plotly)
```


```{r}
#Function : data
#Input : a url to a 50 of the top 1000 movies. Selects and formats movie rank, title, year, directors/actors, votes/gross
#Output : a data frame of 50 movies with variables above

data <- function(x){
  html <- read_html(x)
  top_50 <- html_nodes(html, ".sort-num_votes-visible , .text-muted+ p , .genre , .unbold , .lister-item-header a")
  a <- html_text(top_50) 
  b <- str_replace_all(a, "[\r\n]" , "")
  c <- str_replace_all(b, "[ ]+" , "")
  d <- gsub("[()]", "", c)   
  x <- str_replace_all(d, "[I]+", "")
  as.data.frame(matrix(x, ncol = 6, nrow = 50, byrow= TRUE))
}


a <- data("https://www.imdb.com/search/title/?groups=top_1000&start=1")
b <- data("https://www.imdb.com/search/title/?groups=top_1000&start=51&ref_=adv_nxt")
c <- data("https://www.imdb.com/search/title/?groups=top_1000&start=101&ref_=adv_nxt")
d <- data("https://www.imdb.com/search/title/?groups=top_1000&start=151&ref_=adv_nxt")
e <- data("https://www.imdb.com/search/title/?groups=top_1000&start=201&ref_=adv_nxt")
f <- data("https://www.imdb.com/search/title/?groups=top_1000&start=251&ref_=adv_nxt")
g <- data("https://www.imdb.com/search/title/?groups=top_1000&start=301&ref_=adv_nxt")
h <- data("https://www.imdb.com/search/title/?groups=top_1000&start=351&ref_=adv_nxt")
i <- data("https://www.imdb.com/search/title/?groups=top_1000&start=401&ref_=adv_nxt")
j <- data("https://www.imdb.com/search/title/?groups=top_1000&start=451&ref_=adv_nxt")
k <- data("https://www.imdb.com/search/title/?groups=top_1000&start=501&ref_=adv_nxt")
l <- data("https://www.imdb.com/search/title/?groups=top_1000&start=551&ref_=adv_nxt")
m <- data("https://www.imdb.com/search/title/?groups=top_1000&start=601&ref_=adv_nxt")
n <- data("https://www.imdb.com/search/title/?groups=top_1000&start=651&ref_=adv_nxt")
o <- data("https://www.imdb.com/search/title/?groups=top_1000&start=701&ref_=adv_nxt")
p <- data("https://www.imdb.com/search/title/?groups=top_1000&start=751&ref_=adv_nxt")
q <- data("https://www.imdb.com/search/title/?groups=top_1000&start=801&ref_=adv_nxt")
r <- data("https://www.imdb.com/search/title/?groups=top_1000&start=851&ref_=adv_nxt")
s <- data("https://www.imdb.com/search/title/?groups=top_1000&start=901&ref_=adv_nxt")
t <- data("https://www.imdb.com/search/title/?groups=top_1000&start=951&ref_=adv_nxt")

top <- rbind(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t)
```



```{r warning=FALSE}
#Formatting data frame 

top <- top %>% separate(V1, c("Rank", NA), sep="[.]") %>%
  separate(V4, c("Genre1", "Genre2", "Genre3"), sep="[,]")%>%
  separate(V5, c("Director", "Actor"), sep = "[|]") %>%
  separate(Director, c(NA, "Director"), sep = "[:]") %>%
  separate(Actor, c(NA, "Actors"), sep = "[:]")%>%
  separate(V6, c("Votes", "Gross"), sep = "[|]", extra="merge")  %>%
  separate(Votes, c(NA, "Votes"), sep = "[:]") %>% 
  rename("Title" = "V2", "Year"="V3") %>% 
  separate(Actors, c("Actor1", "Actor2", "Actor3", "Actor4"), sep = "[,]") %>%
  separate(Gross, c("Gross1", "Gross2"), sep="[:]") %>% 
  separate(Gross2, c("Gross2", "Gross3"), sep = "[|]") %>% 
  separate(Gross2, c("Gross2", "Gross4"), sep = "[#]") %>%
  select("Rank":"Votes", "Gross2")%>%
  rename("Gross" = "Gross2") %>%
  replace_with_na(replace = list(Gross = ""))
top_100 <- top %>% arrange(Year) %>% head(100)
```

```{r}
#Producing data frame "actors". Contains 3 rows per movie that correlates each actor in the movie to the "top" actor. Modified top for graphing 
#Format must be "Actor1", "Actor2" then "title"
top_longer <- top  %>% 
  select(Title, Actor1:Actor2)
col_order <- c("Actor1", "Actor2", "Title")
top_longer <- top_longer[, col_order]

#Producing Data frame "Actors" contains just actors and removes all duplicates. Needed for graphing function 
Actors <- top %>% 
  select(Actor1:Actor2, Title) %>%  
  pivot_longer(cols= "Actor1":"Actor2",names_to= "Remove", values_to = 'Actor') %>% 
  select(-"Remove")
#Removes duplicate actors
Actors <- distinct(Actors, Actor)
```

```{r}
#Producing actor network plot 
#Input:
  #d: data frame with top actor linked the 2nd, 3rd and 4th actors divided out by movie
  #vertices: Just a list of all of the actors in movies 
  #direct = FALSE due to multiple actors in multiple movies and aren't directed linked to every other actor 
#Output: list of actors and who they are related to 
actorNetwork <- graph_from_data_frame(d=top_longer, vertices=Actors, directed=FALSE)


#Graph with all actors
ggraph(actorNetwork)+
  geom_edge_link(alpha = 0.5) +     
  geom_node_point(size = 0.5, shape = 21, stroke = 1,
                  fill = 'white', color = 'black') +
  geom_node_text(aes(label=NA), size = 3) +
  theme_void()

#Graph with all actors
par(mar = c(0,0,0,0))
ll <- layout.auto(actorNetwork)

plot(actorNetwork, 
     layout=ll,
     vertex.label= NA,
     vertex.size=5)
```


```{r}
##possibly extra example 

###getting data files 
hp_links <- read_csv("relations.csv")
hp_nodes <- read_csv("characters.csv")
View(hp_nodes)

##creating network
hp_network <- graph_from_data_frame(hp_links,
                                    vertices= hp_nodes,
                                    directed = F)
hp_network %>% 
  edge_density()


hp_network %>% 
  distances() %>% 
  as.vector() %>%              
  as_tibble() %>%              
  plot_ly(x = ~value) %>% 
  add_histogram()

hp_network %>% 
  get_diameter() %>% 
  length()

hp_nodes <- hp_nodes %>%
  mutate(label = name) %>% 
  mutate(title = name) %>% 
  mutate(degree= degree(hp_network)) %>% 
  mutate(value = degree)

hp_links <- hp_links %>% 
  mutate(betweenness= edge_betweenness(hp_network)) %>% 
  mutate(value= betweenness)



edges <- data.frame(from = hp_links$source, to=hp_links$target)


View(hp_nodes)
View(hp_links)

visNetwork(nodes=hp_nodes, edges, main = "Harry Potter Network Diagram") %>% 
  visIgraphLayout(layout = "layout_nicely") %>% 
  visOptions(highlightNearest = T, nodesIdSelection = T)


```

```{r}
Actors <- top %>% 
  select(Actor1:Actor2, Title) %>%  
  pivot_longer(cols= "Actor1":"Actor2",names_to= "Remove", values_to = 'Actor') %>% 
  select(-"Remove")

#View(Actors)
actorswide <- top %>% 
  select(Actor1:Actor2)

distinctactors <- top %>% 
  select(Actor1:Actor2) %>%  
  pivot_longer(cols= "Actor1":"Actor2",names_to= "Remove", values_to = 'Actor') %>%    select(-"Remove")
#Removes duplicate actors
distinctactors <- distinct(distinctactors, Actor)



distinctactors$ID <- seq(1:1304)
distinctactors$Actor2 <- distinctactors$Actor
colnames(distinctactors) <- c("Actor1", "ID", "Actor2")
#View(distinctactors)
merged1 <- merge(distinctactors, actorswide, by="Actor1")
mergedint <-merged1[,-3]
colnames(mergedint) <- c("Actor1", "ID", "Actor2")
mergedint2 <- merge(distinctactors, mergedint, by="Actor2")

finalmerged <- select(mergedint2, -c(1,2,4))
colnames(finalmerged) <- c("Source", "Target")
#View(finalmerged)
hugenodes <- select(distinctactors, c(1,2))
colnames(hugenodes) <- c("Actor", "ID")



huge_links <- finalmerged
huge_nodes <- hugenodes


##creating network
huge_network <- graph_from_data_frame(huge_links,
                                    vertices= huge_nodes$ID,
                                    directed = F)
huge_network %>%   
  edge_density() 


huge_network %>% 
  distances() %>% 
  as.vector() %>%              
  as_tibble() %>%              
  plot_ly(x = ~value) %>% 
  add_histogram()

huge_network %>% 
  get_diameter() %>% 
  length()

huge_nodes <- huge_nodes %>%
  mutate(label = Actor) %>% 
  mutate(title = Actor) %>% 
  mutate(degree= degree(huge_network)) %>% 
  mutate(value = degree)

huge_links <- huge_links %>% 
  mutate(betweenness= edge_betweenness(huge_network)) %>% 
  mutate(value= betweenness)



edges <- data.frame(from = huge_links$Source, to=huge_links$Target)

finalnodes<- as.data.frame(huge_nodes[,-1])
colnames(finalnodes) <- (c("id", "lable", "title", "degree", "value"))
#View(finalnodes)

huge_nodes <- as.data.frame(huge_nodes[,-1])
colnames(huge_nodes) <- (c("id", "label", "title", "degree", "value"))


visNetwork(nodes=huge_nodes, edges, main = "large Network Diagram") %>% 
  visIgraphLayout(layout = "layout_nicely") %>% 
  visOptions(highlightNearest = T, nodesIdSelection = T)

```

```{r}
#Producing data frame with just actors with more then one connection
actorswide2 <- tibble(actorswide)
unique_actors1 <- data_frame("actor1" = unique(actorswide2$Actor1)) 
unique_actors1 <- unique_actors1 %>% arrange(actor1)
unique_actors1$connections <- table(actorswide2$Actor1)
unique_actors2 <- data_frame("actor1" = unique(actorswide2$Actor2)) 
unique_actors2 <- unique_actors2 %>% arrange(actor1)
unique_actors2$connections <- table(actorswide2$Actor2)
unique_1<- rbind(anti_join(unique_actors1, unique_actors2, "actor1"), anti_join(unique_actors2, unique_actors1, "actor1")) 
unique_1 <- unique_1 %>% filter(connections == "1")
actorswide2$tf <- actorswide2$Actor1 %in% unique_1$actor1
actorswide2$tf2 <- actorswide2$Actor2 %in% unique_1$actor1
actorswide2 <- actorswide2 %>% filter(tf == FALSE | tf2 == FALSE)
```

```{r}
#Producing data frame with only actors who have more then one connection
Actors_small <- actorswide2 %>% 
  select(Actor1:Actor2) %>%  
  pivot_longer(cols= "Actor1":"Actor2",names_to= "Remove", values_to = 'Actor') %>% 
  select(-"Remove")
Actors_small<- distinct(Actors_small)

#Producing actor network plot 
#Input:
  #d: data frame with top actor linked the 2nd, 3rd and 4th actors divided out by movie
  #vertices: Just a list of all of the actors in movies 
  #direct = FALSE due to multiple actors in multiple movies and aren't directed linked to every other actor 
#Output: list of actors and who they are related to 
actorNetwork_small <- graph_from_data_frame(d=actorswide2, vertices=Actors_small, directed=FALSE)

#Producing graph with only actors who have more then one connection
ggraph(actorNetwork_small)+
  geom_edge_link(alpha = 0.5) +     
  geom_node_point(size = 0.5, shape = 21, stroke = 1,
                  fill = 'white', color = 'black') +
  geom_node_text(aes(label=NA), size = 3) +
  theme_void()

#Producing graph with only actors who have more then one connection
par(mar = c(0,0,0,0))
ll <- layout.auto(actorNetwork_small)

plot(actorNetwork, 
     layout=ll,
     vertex.label= NA,
     vertex.size=5)
```

```{r}
#Adding IDs to actorswide
Actors_small$ID <- seq(1:730)
#ID1
colnames(actorswide2) <- c("Actor", "Actor2")
merged1_small <- merge(Actors_small, actorswide2, by="Actor")
#ID2
colnames(merged1_small) <- c("Actor1", "ID1", "Actor")
merged2_small <- merge(Actors_small, merged1_small, by="Actor")

finalmerged_small <- select(merged2_small, c(2,4))
colnames(finalmerged_small) <- c("Source", "Target")

nodes_small <- select(Actors_small, c(1,2))
```

```{r}
small_links <- finalmerged_small
small_nodes <- nodes_small


##creating network
small_network <- graph_from_data_frame(small_links,
                                    vertices= small_nodes$ID,
                                    directed = F)
small_network %>%   
  edge_density() 


small_network %>% 
  distances() %>% 
  as.vector() %>%              
  as_tibble() %>%              
  plot_ly(x = ~value) %>% 
  add_histogram()

small_network %>% 
  get_diameter() %>% 
  length()

small_nodes <- small_nodes %>%
  mutate(label = Actor) %>% 
  mutate(title = Actor) %>% 
  mutate(degree= degree(small_network)) %>% 
  mutate(value = degree)

small_links <- small_links %>% 
  mutate(betweenness= edge_betweenness(small_network)) %>% 
  mutate(value= betweenness)



edges <- data.frame(from = small_links$Source, to=small_links$Target)

finalnodes<- as.data.frame(small_nodes[,-1])
colnames(finalnodes) <- (c("id", "lable", "title", "degree", "value"))
#View(finalnodes)

small_nodes <- as.data.frame(small_nodes[,-1])
colnames(small_nodes) <- (c("id", "label", "title", "degree", "value"))


visNetwork(nodes=small_nodes, edges, main = "Small Network Diagram") %>% 
  visIgraphLayout(layout = "layout_nicely") %>% 
  visOptions(highlightNearest = T, nodesIdSelection = T)

```



>>>>>>> bc394c71cecc088718dbaa99ad1dfaa312412ebd
